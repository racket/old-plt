#
# Makefile for mzscheme
#

# dynlink is a script that uses the right set of link commands
DYNLINK = mzc --ld 

srcdir = @srcdir@
prefix = @prefix@

CC = @CC@
CFLAGS = @CFLAGS@ -I$(srcdir)/../include -I$(srcdir)/../src

dynlib:
	$(MAKE) ../mzdyn.o

dynlib3m:
	$(MAKE) ../mzdyn3m.o

dynexample:
	$(MAKE) ../dynexmpl.so

oe:
	$(MAKE) ../oe.so

HEADERS = $(srcdir)/../include/scheme.h $(srcdir)/../src/schemef.h \
          $(srcdir)/../sconfig.h $(srcdir)/../uconfig.h

MZDYNDEP = ../mzdyn.o $(srcdir)/../include/ext.exp $(srcdir)/../include/mzscheme.exp

../mzdyn.o: $(srcdir)/mzdyn.c $(srcdir)/../src/schvers.h  $(HEADERS)
	$(CC) $(CFLAGS) -c $(srcdir)/mzdyn.c -o ../mzdyn.o

../mzdyn3m.o: $(srcdir)/mzdyn.c $(srcdir)/../src/schvers.h  $(HEADERS)
	$(CC) $(CFLAGS) -DMZ_PRECISE_GC -c $(srcdir)/mzdyn.c -o ../mzdyn3m.o

../dynexmpl.so: dynexmpl.o $(MZDYNDEP)
	$(DYNLINK) ../dynexmpl.so dynexmpl.o
dynexmpl.o: $(srcdir)/dynexmpl.c  $(HEADERS)
	$(CC) $(CFLAGS) -c $(srcdir)/dynexmpl.c -o dynexmpl.o

../oe.so: oe.o  $(MZDYNDEP)
	$(DYNLINK) ../oe.so oe.o
oe.o: $(srcdir)/oe.c $(HEADERS)
	$(CC) $(CFLAGS) -c $(srcdir)/oe.c -o oe.o

ILIBDIR = $(prefix)/lib

# Prefix might be relative to srcdir, or it might be absolute, so we
# have to go up and install things from there.

cygwin-install:
	gcc -c -O2 -I$(srcdir)/../include $(srcdir)/mzdyn.c
	gcc -c $(srcdir)/init.cc
	gcc -c $(srcdir)/fixup.c
	dlltool --def mzdyn.def --output-exp mzdyn.exp
	cd ../..; if [ ! -d $(ILIBDIR) ] ; then mkdir $(ILIBDIR) ; fi
	cd ../..; if [ ! -d $(ILIBDIR)/gcc ] ; then mkdir $(ILIBDIR)/gcc ; fi
	cd ../..; cp mzscheme/dynsrc/mzdyn.def $(ILIBDIR)/gcc
	cd ../..; cp mzscheme/dynsrc/mzdyn.exp $(ILIBDIR)/gcc
	cd ../..; cp mzscheme/dynsrc/mzdyn.o $(ILIBDIR)/gcc
	cd ../..; cp mzscheme/dynsrc/init.o $(ILIBDIR)/gcc
	cd ../..; cp mzscheme/dynsrc/fixup.o $(ILIBDIR)/gcc

clean:
	/bin/rm -f *.o Makefile.bak

# Note: 'make depend' is no longer required. As distributed, the below
#       dependencies have been trimmed to include only dependencies
#       on MzScheme files

# DO NOT DELETE THIS LINE -- make depend depends on it.

mzdyn.o: $(srcdir)/../include/escheme.h $(srcdir)/../include/scheme.h $(srcdir)/../src/stypes.h \
         $(srcdir)/../src/schemex.h $(srcdir)/../src/schemexm.h $(srcdir)/../src/schvers.h

dynexmpl.o: $(srcdir)/../include/escheme.h $(srcdir)/../include/scheme.h $(srcdir)/../src/schemexm.h 

oe.o: $(srcdir)/../include/escheme.h $(srcdir)/../include/scheme.h $(srcdir)/../src/stypes.h \
      $(srcdir)/../src/schemex.h $(srcdir)/../src/schemexm.h
