# Makefile for all foreign-related libraires

srcdir = @srcdir@
CC = @CC@
CFLAGS = @CFLAGS@ @COMPFLAGS@ @PREFLAGS@ @PROFFLAGS@ @OPTIONS@ @MZOPTIONS@ \
         -I$(srcdir)/../mzscheme/include -Igcc/libffi/include
AR = @AR@
ARFLAGS = @ARFLAGS@

LIBFFI_A = gcc/libffi/.libs/libffi.a

# compile sub-libraries & foreign.c, then extract all .a files into unpack
all:
	$(MAKE) foreign.o
	$(MAKE) $(LIBFFI_A)
	$(MAKE) unpacked

unpacked: $(LIBFFI_A) unpack
	cd unpack; $(AR) x ../$(LIBFFI_A)
	touch unpacked

$(LIBFFI_A):
	cd gcc/libffi; $(MAKE) libffi.la

unpack:
	mkdir unpack

foreign.o: $(srcdir)/foreign.c $(srcdir)/../mzscheme/include/scheme.h \
           $(srcdir)/../mzscheme/src/schemef.h \
           $(srcdir)/../mzscheme/src/schvers.h
	$(CC) $(CFLAGS) -c $(srcdir)/foreign.c -o foreign.o
