
srcdir = @srcdir@

PALMCPP = m68k-palmos-gcc -E
PALMCC = m68k-palmos-gcc -mnoshort -save-temps
PALMAS = m68k-palmos-as -mno-68881 -m68000 -l
PALMDISASM = m68k-palmos-objdump --disassemble-all
MULTIGEN = multigen
BUILDPRC = build-prc
PILRC = pilrc

PALMINCDIR = /usr/local/palmdev/include

PALMINCS = -I$(PALMINCDIR)/Core \
           -I$(PALMINCDIR)/Core/Hardware \
           -I$(PALMINCDIR)/Core/System \
           -I$(PALMINCDIR)/Core/UI
CPPFLAGS = @OPTIONS@ -I$(srcdir)/../include
XCFLAGS = -I.
CFLAGS = $(XCFLAGS) $(CPPFLAGS) $(PALMINCS)
DBG = -g

XFORM = ../mzscheme -rq $(srcdir)/../gc2/xform.ss --notes --palm  ../gc2/ctok "$(PALMCPP) $(CPPFLAGS) -DUSE_SENORA_GC $(PALMINCS)"
XSRCDIR = xsrc
SRCDIR = $(srcdir)/../src

OBJS =  salloc.o \
	bignum.o \
	bool.o \
	builtin.o \
	char.o \
	complex.o \
	dynext.o \
	env.o \
	error.o \
	eval.o \
	file.o \
	fun.o \
	hash.o \
	image.o \
	list.o \
	network.o \
	numarith.o \
	number.o \
	numcomp.o \
	numstr.o \
        objclass.o \
        object.o \
	port.o \
	portfun.o \
	print.o \
	process.o \
	promise.o \
        rational.o \
	read.o \
	regexp.o \
	sema.o \
	setjmpup.o \
	string.o \
	struct.o \
	symbol.o \
	syntax.o \
	type.o \
        unit.o \
        unitsig.o \
	vector.o \
	sgc.o \
        mz-sections.o \
	utils.o \
	palm.o

XSRCS = $(XSRCDIR)/salloc.c \
	$(XSRCDIR)/bignum.c \
	$(XSRCDIR)/bool.c \
	$(XSRCDIR)/builtin.c \
	$(XSRCDIR)/char.c \
	$(XSRCDIR)/complex.c \
	$(XSRCDIR)/dynext.c \
	$(XSRCDIR)/env.c \
	$(XSRCDIR)/error.c \
	$(XSRCDIR)/eval.c \
	$(XSRCDIR)/file.c \
	$(XSRCDIR)/fun.c \
	$(XSRCDIR)/hash.c \
	$(XSRCDIR)/image.c \
	$(XSRCDIR)/list.c \
	$(XSRCDIR)/network.c \
	$(XSRCDIR)/numarith.c \
	$(XSRCDIR)/number.c \
	$(XSRCDIR)/numcomp.c \
	$(XSRCDIR)/numstr.c \
        $(XSRCDIR)/objclass.c \
        $(XSRCDIR)/object.c \
	$(XSRCDIR)/port.c \
	$(XSRCDIR)/portfun.c \
	$(XSRCDIR)/print.c \
	$(XSRCDIR)/process.c \
	$(XSRCDIR)/promise.c \
        $(XSRCDIR)/rational.c \
	$(XSRCDIR)/read.c \
	$(XSRCDIR)/regexp.c \
	$(XSRCDIR)/sema.c \
	$(XSRCDIR)/setjmpup.c \
	$(XSRCDIR)/string.c \
	$(XSRCDIR)/struct.c \
	$(XSRCDIR)/symbol.c \
	$(XSRCDIR)/syntax.c \
	$(XSRCDIR)/type.c \
        $(XSRCDIR)/unit.c \
        $(XSRCDIR)/unitsig.c \
	$(XSRCDIR)/vector.c \
	$(XSRCDIR)/sgc.c

XMAPS = $(XSRCDIR)/salloc.map \
	$(XSRCDIR)/bignum.map \
	$(XSRCDIR)/bool.map \
	$(XSRCDIR)/builtin.map \
	$(XSRCDIR)/char.map \
	$(XSRCDIR)/complex.map \
	$(XSRCDIR)/dynext.map \
	$(XSRCDIR)/env.map \
	$(XSRCDIR)/error.map \
	$(XSRCDIR)/eval.map \
	$(XSRCDIR)/file.map \
	$(XSRCDIR)/fun.map \
	$(XSRCDIR)/hash.map \
	$(XSRCDIR)/image.map \
	$(XSRCDIR)/list.map \
	$(XSRCDIR)/network.map \
	$(XSRCDIR)/numarith.map \
	$(XSRCDIR)/number.map \
	$(XSRCDIR)/numcomp.map \
	$(XSRCDIR)/numstr.map \
        $(XSRCDIR)/objclass.map \
        $(XSRCDIR)/object.map \
	$(XSRCDIR)/port.map \
	$(XSRCDIR)/portfun.map \
	$(XSRCDIR)/print.map \
	$(XSRCDIR)/process.map \
	$(XSRCDIR)/promise.map \
        $(XSRCDIR)/rational.map \
	$(XSRCDIR)/read.map \
	$(XSRCDIR)/regexp.map \
	$(XSRCDIR)/sema.map \
	$(XSRCDIR)/setjmpup.map \
	$(XSRCDIR)/string.map \
	$(XSRCDIR)/struct.map \
	$(XSRCDIR)/symbol.map \
	$(XSRCDIR)/syntax.map \
	$(XSRCDIR)/type.map \
        $(XSRCDIR)/unit.map \
        $(XSRCDIR)/unitsig.map \
	$(XSRCDIR)/vector.map \
	$(XSRCDIR)/sgc.map

all: ../gc2/ctok xsrc
	$(MAKE) mzscheme.prc

xsrcs: $(XSRCS)

xsrc:
	mkdir xsrc

segmap.h: $(XSRCS) $(srcdir)/partition.ss
	../mzscheme -qr $(srcdir)/partition.ss $(XMAPS)

xobjects: $(OBJS)

mzscheme.prc: mzscheme built-res.dmy
	$(BUILDPRC) -o mzscheme.prc mz.def mzscheme *.bin

mzscheme: $(OBJS) mz-sections.ld
	$(PALMCC) $(DBG) -o mzscheme $(OBJS) mz-sections.ld -lm

mz-sections.s: mz.def
	$(MULTIGEN) mz.def

built-res.dmy: $(srcdir)/mzscheme.rcp $(srcdir)/mzscheme.pbm $(srcdir)/resnum.h
	rm -f *.bin
	$(PILRC) -I $(srcdir) $(srcdir)/mzscheme.rcp .
	touch built-res.dmy

mzscheme.s: mzscheme
	$(PALMDISASM) mzscheme > mzscheme.s

debug-info.ss: mzscheme.s $(OBJS) $(srcdir)/debuginfo.ss
	../mzscheme -qr $(srcdir)/debuginfo.ss -o debug-info.ss -d mzscheme.s $(OBJS)

XFORMDEP = $(srcdir)/../gc2/xform.ss

$(XSRCDIR)/salloc.c: ../src/salloc.o $(XFORMDEP)
	$(XFORM) $(SRCDIR)/salloc.c $(XSRCDIR)/salloc.c $(XSRCDIR)/salloc.map 
$(XSRCDIR)/bignum.c: ../src/bignum.o $(XFORMDEP)
	$(XFORM) $(SRCDIR)/bignum.c $(XSRCDIR)/bignum.c $(XSRCDIR)/bignum.map
$(XSRCDIR)/bool.c: ../src/bool.o $(XFORMDEP)
	$(XFORM) $(SRCDIR)/bool.c $(XSRCDIR)/bool.c $(XSRCDIR)/bool.map
$(XSRCDIR)/builtin.c: ../src/builtin.o $(XFORMDEP)
	$(XFORM) $(SRCDIR)/builtin.c $(XSRCDIR)/builtin.c $(XSRCDIR)/builtin.map
$(XSRCDIR)/char.c: ../src/char.o $(XFORMDEP)
	$(XFORM) $(SRCDIR)/char.c $(XSRCDIR)/char.c $(XSRCDIR)/char.map
$(XSRCDIR)/complex.c: ../src/complex.o $(XFORMDEP)
	$(XFORM) $(SRCDIR)/complex.c $(XSRCDIR)/complex.c $(XSRCDIR)/complex.map
$(XSRCDIR)/dynext.c: ../src/dynext.o $(XFORMDEP)
	$(XFORM) $(SRCDIR)/dynext.c $(XSRCDIR)/dynext.c $(XSRCDIR)/dynext.map
$(XSRCDIR)/env.c: ../src/env.o $(XFORMDEP)
	$(XFORM) $(SRCDIR)/env.c $(XSRCDIR)/env.c $(XSRCDIR)/env.map
$(XSRCDIR)/error.c: ../src/error.o $(XFORMDEP)
	$(XFORM) $(SRCDIR)/error.c $(XSRCDIR)/error.c $(XSRCDIR)/error.map
$(XSRCDIR)/eval.c: ../src/eval.o $(XFORMDEP)
	$(XFORM) $(SRCDIR)/eval.c $(XSRCDIR)/eval.c $(XSRCDIR)/eval.map
$(XSRCDIR)/file.c: ../src/file.o $(XFORMDEP)
	$(XFORM) $(SRCDIR)/file.c $(XSRCDIR)/file.c $(XSRCDIR)/file.map
$(XSRCDIR)/fun.c: ../src/fun.o $(XFORMDEP)
	$(XFORM) $(SRCDIR)/fun.c $(XSRCDIR)/fun.c $(XSRCDIR)/fun.map
$(XSRCDIR)/hash.c: ../src/hash.o $(XFORMDEP)
	$(XFORM) $(SRCDIR)/hash.c $(XSRCDIR)/hash.c $(XSRCDIR)/hash.map
$(XSRCDIR)/image.c: ../src/image.o $(XFORMDEP)
	$(XFORM) $(SRCDIR)/image.c $(XSRCDIR)/image.c $(XSRCDIR)/image.map
$(XSRCDIR)/list.c: ../src/list.o $(XFORMDEP)
	$(XFORM) $(SRCDIR)/list.c $(XSRCDIR)/list.c $(XSRCDIR)/list.map
$(XSRCDIR)/network.c: ../src/network.o $(XFORMDEP)
	$(XFORM) $(SRCDIR)/network.c $(XSRCDIR)/network.c $(XSRCDIR)/network.map
$(XSRCDIR)/numarith.c: ../src/numarith.o $(XFORMDEP)
	$(XFORM) $(SRCDIR)/numarith.c $(XSRCDIR)/numarith.c $(XSRCDIR)/numarith.map
$(XSRCDIR)/number.c: ../src/number.o $(XFORMDEP)
	$(XFORM) $(SRCDIR)/number.c $(XSRCDIR)/number.c $(XSRCDIR)/number.map
$(XSRCDIR)/numcomp.c: ../src/numcomp.o $(XFORMDEP)
	$(XFORM) $(SRCDIR)/numcomp.c $(XSRCDIR)/numcomp.c $(XSRCDIR)/numcomp.map
$(XSRCDIR)/numstr.c: ../src/numstr.o $(XFORMDEP)
	$(XFORM) $(SRCDIR)/numstr.c $(XSRCDIR)/numstr.c $(XSRCDIR)/numstr.map
$(XSRCDIR)/objclass.c: ../src/objclass.o $(XFORMDEP)
	$(XFORM) $(SRCDIR)/objclass.c $(XSRCDIR)/objclass.c $(XSRCDIR)/objclass.map
$(XSRCDIR)/object.c: ../src/object.o $(XFORMDEP)
	$(XFORM) $(SRCDIR)/object.c $(XSRCDIR)/object.c $(XSRCDIR)/object.map
$(XSRCDIR)/port.c: ../src/port.o $(XFORMDEP)
	$(XFORM) $(SRCDIR)/port.c $(XSRCDIR)/port.c $(XSRCDIR)/port.map
$(XSRCDIR)/portfun.c: ../src/portfun.o $(XFORMDEP)
	$(XFORM) $(SRCDIR)/portfun.c $(XSRCDIR)/portfun.c $(XSRCDIR)/portfun.map
$(XSRCDIR)/print.c: ../src/print.o $(XFORMDEP)
	$(XFORM) $(SRCDIR)/print.c $(XSRCDIR)/print.c $(XSRCDIR)/print.map
$(XSRCDIR)/process.c: ../src/process.o $(XFORMDEP)
	$(XFORM) $(SRCDIR)/process.c $(XSRCDIR)/process.c $(XSRCDIR)/process.map
$(XSRCDIR)/promise.c: ../src/promise.o $(XFORMDEP)
	$(XFORM) $(SRCDIR)/promise.c $(XSRCDIR)/promise.c $(XSRCDIR)/promise.map
$(XSRCDIR)/rational.c: ../src/rational.o $(XFORMDEP)
	$(XFORM) $(SRCDIR)/rational.c $(XSRCDIR)/rational.c $(XSRCDIR)/rational.map
$(XSRCDIR)/read.c: ../src/read.o $(XFORMDEP)
	$(XFORM) $(SRCDIR)/read.c $(XSRCDIR)/read.c $(XSRCDIR)/read.map
$(XSRCDIR)/regexp.c: ../src/regexp.o $(XFORMDEP)
	$(XFORM) $(SRCDIR)/regexp.c $(XSRCDIR)/regexp.c $(XSRCDIR)/regexp.map
$(XSRCDIR)/sema.c: ../src/sema.o $(XFORMDEP)
	$(XFORM) $(SRCDIR)/sema.c $(XSRCDIR)/sema.c $(XSRCDIR)/sema.map
$(XSRCDIR)/setjmpup.c: ../src/setjmpup.o $(XFORMDEP)
	$(XFORM) $(SRCDIR)/setjmpup.c $(XSRCDIR)/setjmpup.c $(XSRCDIR)/setjmpup.map
$(XSRCDIR)/string.c: ../src/string.o $(XFORMDEP)
	$(XFORM) $(SRCDIR)/string.c $(XSRCDIR)/string.c $(XSRCDIR)/string.map -I../src
$(XSRCDIR)/struct.c: ../src/struct.o $(XFORMDEP)
	$(XFORM) $(SRCDIR)/struct.c $(XSRCDIR)/struct.c $(XSRCDIR)/struct.map
$(XSRCDIR)/symbol.c: ../src/symbol.o $(XFORMDEP)
	$(XFORM) $(SRCDIR)/symbol.c $(XSRCDIR)/symbol.c $(XSRCDIR)/symbol.map
$(XSRCDIR)/syntax.c: ../src/syntax.o $(XFORMDEP)
	$(XFORM) $(SRCDIR)/syntax.c $(XSRCDIR)/syntax.c $(XSRCDIR)/syntax.map
$(XSRCDIR)/type.c: ../src/type.o $(XFORMDEP)
	$(XFORM) $(SRCDIR)/type.c $(XSRCDIR)/type.c $(XSRCDIR)/type.map
$(XSRCDIR)/unit.c: ../src/unit.o $(XFORMDEP)
	$(XFORM) $(SRCDIR)/unit.c $(XSRCDIR)/unit.c $(XSRCDIR)/unit.map
$(XSRCDIR)/unitsig.c: ../src/unitsig.o $(XFORMDEP)
	$(XFORM) $(SRCDIR)/unitsig.c $(XSRCDIR)/unitsig.c $(XSRCDIR)/unitsig.map
$(XSRCDIR)/vector.c: ../src/vector.o $(XFORMDEP)
	$(XFORM) $(SRCDIR)/vector.c $(XSRCDIR)/vector.c $(XSRCDIR)/vector.map
$(XSRCDIR)/sgc.c: $(srcdir)/../sgc/sgc.c $(XFORMDEP)
	$(XFORM) $(srcdir)/../sgc/sgc.c $(XSRCDIR)/sgc.c $(XSRCDIR)/sgc.map

OBJDEP = segmap.h

salloc.o: $(OBJDEP) $(XSRCDIR)/salloc.c
	$(PALMCC) $(XCFLAGS) -c $(XSRCDIR)/salloc.c -o salloc.o
bignum.o: $(OBJDEP) $(XSRCDIR)/bignum.c
	$(PALMCC) $(XCFLAGS) -c $(XSRCDIR)/bignum.c -o bignum.o
bool.o: $(OBJDEP) $(XSRCDIR)/bool.c
	$(PALMCC) $(XCFLAGS) -c $(XSRCDIR)/bool.c -o bool.o
builtin.o: $(OBJDEP) $(XSRCDIR)/builtin.c
	$(PALMCC) $(XCFLAGS) -c $(XSRCDIR)/builtin.c -o builtin.o
char.o: $(OBJDEP) $(XSRCDIR)/char.c
	$(PALMCC) $(XCFLAGS) -c $(XSRCDIR)/char.c -o char.o
complex.o: $(OBJDEP) $(XSRCDIR)/complex.c
	$(PALMCC) $(XCFLAGS) -c $(XSRCDIR)/complex.c -o complex.o
dynext.o: $(OBJDEP) $(XSRCDIR)/dynext.c
	$(PALMCC) $(XCFLAGS) -c $(XSRCDIR)/dynext.c -o dynext.o
env.o: $(OBJDEP) $(XSRCDIR)/env.c
	$(PALMCC) $(XCFLAGS) -c $(XSRCDIR)/env.c -o env.o
error.o: $(OBJDEP) $(XSRCDIR)/error.c
	$(PALMCC) $(XCFLAGS) -c $(XSRCDIR)/error.c -o error.o
eval.o: $(OBJDEP) $(XSRCDIR)/eval.c
	$(PALMCC) $(XCFLAGS) -c $(XSRCDIR)/eval.c -o eval.o
file.o: $(OBJDEP) $(XSRCDIR)/file.c
	$(PALMCC) $(XCFLAGS) -c $(XSRCDIR)/file.c -o file.o
fun.o: $(OBJDEP) $(XSRCDIR)/fun.c
	$(PALMCC) $(XCFLAGS) -c $(XSRCDIR)/fun.c -o fun.o
hash.o: $(OBJDEP) $(XSRCDIR)/hash.c
	$(PALMCC) $(XCFLAGS) -c $(XSRCDIR)/hash.c -o hash.o
image.o: $(OBJDEP) $(XSRCDIR)/image.c
	$(PALMCC) $(XCFLAGS) -c $(XSRCDIR)/image.c -o image.o
list.o: $(OBJDEP) $(XSRCDIR)/list.c
	$(PALMCC) $(XCFLAGS) -c $(XSRCDIR)/list.c -o list.o
network.o: $(OBJDEP) $(XSRCDIR)/network.c
	$(PALMCC) $(XCFLAGS) -c $(XSRCDIR)/network.c -o network.o
numarith.o: $(OBJDEP) $(XSRCDIR)/numarith.c
	$(PALMCC) $(XCFLAGS) -c $(XSRCDIR)/numarith.c -o numarith.o
number.o: $(OBJDEP) $(XSRCDIR)/number.c
	$(PALMCC) $(XCFLAGS) -c $(XSRCDIR)/number.c -o number.o
numcomp.o: $(OBJDEP) $(XSRCDIR)/numcomp.c
	$(PALMCC) $(XCFLAGS) -c $(XSRCDIR)/numcomp.c -o numcomp.o
numstr.o: $(OBJDEP) $(XSRCDIR)/numstr.c
	$(PALMCC) $(XCFLAGS) -c $(XSRCDIR)/numstr.c -o numstr.o
objclass.o: $(OBJDEP) $(XSRCDIR)/objclass.c
	$(PALMCC) $(XCFLAGS) -c $(XSRCDIR)/objclass.c -o objclass.o
object.o: $(OBJDEP) $(XSRCDIR)/object.c
	$(PALMCC) $(XCFLAGS) -c $(XSRCDIR)/object.c -o object.o
port.o: $(OBJDEP) $(XSRCDIR)/port.c
	$(PALMCC) $(XCFLAGS) -c $(XSRCDIR)/port.c -o port.o
portfun.o: $(OBJDEP) $(XSRCDIR)/portfun.c
	$(PALMCC) $(XCFLAGS) -c $(XSRCDIR)/portfun.c -o portfun.o
print.o: $(OBJDEP) $(XSRCDIR)/print.c
	$(PALMCC) $(XCFLAGS) -c $(XSRCDIR)/print.c -o print.o
process.o: $(OBJDEP) $(XSRCDIR)/process.c
	$(PALMCC) $(XCFLAGS) -c $(XSRCDIR)/process.c -o process.o
promise.o: $(OBJDEP) $(XSRCDIR)/promise.c
	$(PALMCC) $(XCFLAGS) -c $(XSRCDIR)/promise.c -o promise.o
rational.o: $(OBJDEP) $(XSRCDIR)/rational.c
	$(PALMCC) $(XCFLAGS) -c $(XSRCDIR)/rational.c -o rational.o
read.o: $(OBJDEP) $(XSRCDIR)/read.c
	$(PALMCC) $(XCFLAGS) -c $(XSRCDIR)/read.c -o read.o
regexp.o: $(OBJDEP) $(XSRCDIR)/regexp.c
	$(PALMCC) $(XCFLAGS) -c $(XSRCDIR)/regexp.c -o regexp.o
sema.o: $(OBJDEP) $(XSRCDIR)/sema.c
	$(PALMCC) $(XCFLAGS) -c $(XSRCDIR)/sema.c -o sema.o
setjmpup.o: $(OBJDEP) $(XSRCDIR)/setjmpup.c
	$(PALMCC) $(XCFLAGS) -c $(XSRCDIR)/setjmpup.c -o setjmpup.o
string.o: $(OBJDEP) $(XSRCDIR)/string.c
	$(PALMCC) $(XCFLAGS) -c $(XSRCDIR)/string.c -o string.o
struct.o: $(OBJDEP) $(XSRCDIR)/struct.c
	$(PALMCC) $(XCFLAGS) -c $(XSRCDIR)/struct.c -o struct.o
symbol.o: $(OBJDEP) $(XSRCDIR)/symbol.c
	$(PALMCC) $(XCFLAGS) -c $(XSRCDIR)/symbol.c -o symbol.o
syntax.o: $(OBJDEP) $(XSRCDIR)/syntax.c
	$(PALMCC) $(XCFLAGS) -c $(XSRCDIR)/syntax.c -o syntax.o
type.o: $(OBJDEP) $(XSRCDIR)/type.c
	$(PALMCC) $(XCFLAGS) -c $(XSRCDIR)/type.c -o type.o
unit.o: $(OBJDEP) $(XSRCDIR)/unit.c
	$(PALMCC) $(XCFLAGS) -c $(XSRCDIR)/unit.c -o unit.o
unitsig.o: $(OBJDEP) $(XSRCDIR)/unitsig.c
	$(PALMCC) $(XCFLAGS) -c $(XSRCDIR)/unitsig.c -o unitsig.o
vector.o: $(OBJDEP) $(XSRCDIR)/vector.c
	$(PALMCC) $(XCFLAGS) -c $(XSRCDIR)/vector.c -o vector.o
sgc.o: $(OBJDEP) $(XSRCDIR)/sgc.c
	$(PALMCC) $(XCFLAGS) -c $(XSRCDIR)/sgc.c -o sgc.o
mz-sections.o: mz-sections.s
	$(PALMAS) -o mz-sections.o mz-sections.s
utils.o: $(srcdir)/utils.c
	$(PALMCC) $(CFLAGS) $(DBG) -c $(srcdir)/utils.c -o utils.o
palm.o: $(srcdir)/palm.c segmap.h
	$(PALMCC) $(CFLAGS) $(DBG) -c $(srcdir)/palm.c -o palm.o

../gc2/ctok: ../gc2/lex.yy.c
	gcc -g -o ../gc2/ctok ../gc2/lex.yy.c

../gc2/lex.yy.c: $(srcdir)/../gc2/ctok.lex
	cd ../gc2; flex $(srcdir)/../gc2/ctok.lex
