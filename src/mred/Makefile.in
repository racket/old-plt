
srcdir = @srcdir@
prefix = @prefix@

WXDIR = $(srcdir)/../wxxt

PLTSRCDIR = $(srcdir)/..

###########################
#      Common Macros      #
###########################
CC = @CC@
CXX = @CXX@
LINKER = @MREDLINKER@
PERL = @PERL@
RANLIB = @RANLIB@
AR = @AR@
ARFLAGS = @ARFLAGS@
OPTIONS = @OPTIONS@ @MROPTIONS@
COMPFLAGS = @CFLAGS@ @PROFFLAGS@
XINCLUDE = @X_CFLAGS@
XLIB = @X_LIBS@
LDLIBS = @X_PRE_LIBS@ -lXaw -lXmu -lXt -lX11 -lXext @X_EXTRA_LIBS@ @LIBS@
GCDIRECTORY = @GCDIR@
WBUILD = @WBUILD@

WXINC = $(PLTSRCDIR)/wxxt/src/AIAI-include -I$(PLTSRCDIR)/wxxt/src
NOGCINC = -I$(WXINC) -I$(PLTSRCDIR)/mred/wxme/ -I$(PLTSRCDIR)/mzscheme/include/
INC = -I$(PLTSRCDIR)/mzscheme/$(GCDIRECTORY) $(NOGCINC)
CXXFLAGS = $(XINCLUDE) $(INC) $(OPTIONS) -Dwx_xt $(COMPFLAGS)
CPPFLAGS = $(CXXFLAGS)
CFLAGS = $(XINCLUDE) $(INC) $(OPTIONS) -Dwx_xt $(COMPFLAGS)
LDFLAGS = $(XLIB)
###########################

MREDLDFLAGS = $(LDFLAGS)
WXLIBSNORM = mred.o mredx.o wxGC.o wxJPEG.o wxs/libwxscheme.a wxme/libwxme.a ../wxxt/src/libwx_xt.a ../wxxt/contrib/xpm/lib/libXpm.a ../wxxt/utils/image/src/libimage_xt.a ../wxcommon/jpeg/libjpeg.a
WXLIBSDYN = libmred.@LIBSFX@
MREDLDLIBS = ../mzscheme/libmzscheme.@LIBSFX@ ../mzscheme/libmzgc.@LIBSFX@ $(@WXLIBS@) $(LDLIBS)

MREDOBJECTS = mrmain.o

MZSCHEME = ../mzscheme/libmzscheme.@LIBSFX@ ../mzscheme/libmzgc.@LIBSFX@
WXSCHEME = wxs/libwxscheme.a
WXME = wxme/libwxme.a

INSTALLDEST=/home/scheme/plt

MRSTATIC = 
MRSTATIC_STUB =

WXINCDEP = $(WXDIR)/src/Windows/Window.h

MZEXTRAEXPORT='GCDIR=$(GCDIRECTORY)'

all:
	$(MAKE) wx
	cd wxs; $(MAKE)
	cd wxme; $(MAKE)
	$(MAKE) mred

bin:
	$(MAKE) mred

mred : $(MZSCHEME) mrmain.o $(MREDOBJECTS) $(@WXLIBS@) $(MRSTATIC_STUB)
	$(LINKER) $(MREDLDFLAGS) $(MRSTATIC) -o mred $(MREDOBJECTS) $(MREDLDLIBS) $(MRSTATIC_STUB)

libmred.@LIBSFX@: $(WXLIBSNORM)
	$(AR) $(ARFLAGS) libmred.@LIBSFX@ $(WXLIBSNORM)

ee-app: mred mred_ee.o
	if [ "$(EEAPP)" = '' ] ; then echo "ERROR: You must specify EEAPP" ; else $(LINKER) $(MREDLDFLAGS) $(MRSTATIC) -o $(EEAPP) mred_ee.o mredx.o $(EEOBJECTS) $(MREDLDLIBS) $(MRSTATIC_STUB) ; fi

sunos4-static: dl_stub.o
	$(MAKE) mred MRSTATIC=-static  MRSTATIC_STUB='dl_stub.o' LDNONSTATICLIBS=''

solaris-static:
	$(MAKE) mred MRSTATIC="-Wl,-Bstatic" LDNONSTATICLIBS='-Wl,-Bdynamic -ldl -Wl,-Bstatic'

linux-static:
	$(MAKE) mred MRSTATIC=--static LDNONSTATICLIBS='-ldl'

wx:
	cd ../wxxt/src/x; $(MAKE)

mred.o :  $(srcdir)/mred.cxx $(srcdir)/wxme/wx_media.h $(srcdir)/wxme/wx_medad.h \
          $(srcdir)/wxs/wxscheme.h $(srcdir)/mred.h \
          $(srcdir)/../mzscheme/include/scheme.h $(srcdir)/../mzscheme/src/schvers.h \
          $(srcdir)/wxs/wxsmred.h $(WXINCDEP) $(WXDIR)/src/Windows/Frame.h \
          $(WXDIR)/src/DataStructures/Object.h $(srcdir)/../wxcommon/wxGC.h \
          $(srcdir)/../wxcommon/wx_list.h
	$(CXX) $(CPPFLAGS) $(LOCALFLAGS) -c $(srcdir)/mred.cxx -o mred.o

mrmain.o :  $(srcdir)/mrmain.cxx $(srcdir)/mred.h $(srcdir)/wxs/wxsmred.h \
            $(srcdir)/../mzscheme/cmdline.inc $(srcdir)/../mzscheme/src/stypes.h
	$(CXX) $(CPPFLAGS) $(LOCALFLAGS) -c $(srcdir)/mrmain.cxx -o mrmain.o

mred_ee.o : mred.o
	$(CXX) $(CPPFLAGS) $(LOCALFLAGS) -DSTANDALONE_WITH_EMBEDDED_EXTENSION -c $(srcdir)/mred.cxx -o mred_ee.o

ee-main:
	$(MAKE) mred_ee.o

mredx.o : $(srcdir)/mredx.cxx $(srcdir)/../mzscheme/include/scheme.h $(srcdir)/mred.h \
          $(WXDIR)/src/Windows/Frame.h $(WXDIR)/src/DataStructures/Object.h \
          $(srcdir)/../wxcommon/wxGC.h $(srcdir)/../wxcommon/wx_list.h \
          $(srcdir)/../mzscheme/src/stypes.h
	$(CXX) $(CPPFLAGS) $(LOCALFLAGS) -c $(srcdir)/mredx.cxx -o mredx.o

wxGC.o : $(srcdir)/../wxcommon/wxGC.cxx $(srcdir)/../wxcommon/wxGC.h \
         $(srcdir)/../mzscheme/src/stypes.h
	$(CXX) $(CPPFLAGS) $(LOCALFLAGS) -c $(srcdir)/../wxcommon/wxGC.cxx -o wxGC.o

wxJPEG.o : $(srcdir)/../wxcommon/wxJPEG.cxx $(srcdir)/../wxcommon/wxGC.h
	$(CXX) $(CPPFLAGS) $(LOCALFLAGS) -I../wxcommon/jpeg -I$(srcdir)/../wxcommon/jpeg -c $(srcdir)/../wxcommon/wxJPEG.cxx -o wxJPEG.o

dl_stub.o: $(srcdir)/misc/dl_stub.c
	$(CC) $(CPPFLAGS) $(LOCALFLAGS) -c $(srcdir)/misc/dl_stub.c -o dl_stub.o

sgilinkhack.o:
	$(CXX) $(CPPFLAGS) $(LOCALFLAGS) -c $(srcdir)/misc/sgilinkhack.cxx -o sgilinkhack.o

$(WXDIR)/libwx_xt.a:
	$(MAKE) wx

../wxcommon/jpeg/libjpeg.a:
	cd ../wxcommon/jpeg; $(MAKE) libjpeg.a

clean:
	cd ../wxxt/src/x; $(MAKE) clean
	rm -f *.o core
	rm -f gc2/*.o gc2/xsrc/*.c gc2/xsrc/*.cc
	cd wxme; $(MAKE) clean
	cd wxs; $(MAKE) clean
	cd ../wxcommon/jpeg; $(MAKE) clean

ICP=@ICP@

# Prefix might be relative to srcdir, or it might be absolute, so we
# have to go up and install things from there.

install-no-lib:
	echo "no dynamic libs"

install-lib:
	cd ..; $(ICP) mred/libmred.@LIBSFX@ $(prefix)/lib/

install:
	cd ..; if [ ! -d $(prefix)/bin ] ; then mkdir $(prefix)/bin ; fi
	cd ..; rm -f $(prefix)/bin/mred
	cd ..; $(ICP) mred/mred $(prefix)/bin/
	$(MAKE) @MRLIBINSTALL@

3m:
	$(MAKE) all
	cd gc2; $(MAKE) 3m

